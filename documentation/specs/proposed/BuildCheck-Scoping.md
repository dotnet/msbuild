# Scoping BuildCheck analysis

In a build, some MSBuild files are imported many times (repo-wide imports like a root `Directory.Packages.props`), some files are evaluated exactly once (single-targeted projects), and some are evaluated multiple times (multi-targeted projects). We'd like to have BuildCheck analysis that results in sensible errors for the different situations, as well as scoping for rules to enable some types of analysis.

## Scenarios of interest

* Straightforward rules scoped to projects:
  * "Don't target `netcoreapp3.1`"
  * "Don't use globbing"
* Repo-level rules aimed at unifiying configuration
  * "Don't set copyright information in projects, inherit it from the repo"
* Code quality rules
  * Should fire only for code that is under the user's control
  * Should NOT fire for `Common.targets`, but should fire for `Directory.Build.props`
  * There should be some level of configuration for whether NuGet package build logic is analyzed
* Deduplication of analysis and results in multiply-evaluated files
  * Rules in common imports should be reported once, not once per import
  * For performance, it's nice to _analyze_ things only once
  * But some rules will fire or not fire based on project-level differences, so that may not always be possible

## Scopes

* `Project`: The project file itself and any imports that are unique to it
* `RepoImport`: A file that is present in the repo and imported by multiple projects
* `PackageImport`: A file that is imported from a known package location
* `All`: All files, regardless of import source

## Sources

* `Project`: The project file itself
* `SingleProjectImport`: An import from within the cone of the repo that is imported by a single project
* `RepoImport`: An import from within the cone of the repo that is imported by multiple projects
* `PackageImport`: An import from a known package location _or_ a file known to be generated by a package system like NuGet's `ProjectName.csproj.nuget.g.props`
* `SdkImport`: An import from an MSBuild SDK
* `All`: All sources, including things like common targets

## Categorizing a file

We should categorize files as soon as possible, so that we can avoid overhead of analyzing things that won't be in scope.

There are two critical pieces of information to determine categorization: repo root location and package cache location.

Repo root is known by projects that use SourceLink (on by default as of .NET 8), but it doesn't locate the root until build time, using a task `Microsoft.Build.Tasks.Git.LocateRepository` in the target `InitializeSourceControlInformationFromSourceControlManager`. This is pretty late to do categorization.

NuGet packages are in the folders defined by property `$(NuGetPackageFolders)`, which is available pretty early in evaluation because it's set in `ProjectName.csproj.nuget.g.props`. If we can hold categorization until that's available, we might be in good shape.

We should be able to easily recognize SDK paths and the MSBuild directory to categories SDKs and common imports.

## The V1 functionality

Based on the design above - a simplified first version will be provided.
Scoping categories:
 * `ProjectFile`
 * `WorkTreeImports`
 * `All`

Only the `WorkTreeImports` has specific handling - it will be achieved by excluding known 'immutable locations' (sdk, framework, reference assemblies and nuget cache roots) and everything else will be regarded as 'user code'. It is a significant simplification - but allows not relying on the need to obtain source control metadata, that might not be yet available early in the build.
