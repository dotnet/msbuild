<Project>
  <PropertyGroup>
    <OptProfMetadataJson>$(BUILD_STAGINGDIRECTORY)\InsertionOutputs\Metadata.json</OptProfMetadataJson>
    <OptProfMetadataOutputDir>$(ArtifactsDir)\VSSetup\$(Configuration)</OptProfMetadataOutputDir>
    <OptProfMetadataOutputPath>$(OptProfMetadataOutputDir)\Metadata.json</OptProfMetadataOutputPath>
  </PropertyGroup>

  <!-- Preserve OptProf drop information (that Arcade targets have located) in a file so that
       `.opt-prof.yml` can pick it up during testing. -->
  <Target Name="UpdateOptProfMetadataJson" AfterTargets="_DownloadVisualStudioOptimizationDataOpt">
    <MakeDir Directories="$(OptProfMetadataOutputDir)" />
    <Exec Command="powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command &quot;($json = Get-Content '$(OptProfMetadataJson)' -Raw | ConvertFrom-Json); $json | Add-Member -MemberType NoteProperty -Name 'OptimizationData' -Value '$(_DropName)' -Force; $json | ConvertTo-Json | Set-Content '$(OptProfMetadataOutputPath)'&quot;" />
  </Target>
</Project>
