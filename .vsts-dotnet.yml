variables:
- name: BuildConfiguration
  value: 'Release'
- name: TeamName
  value: MSBuild
- name: ArtifactServices.Symbol.AccountName
  value: microsoft
- name: ArtifactServices.Symbol.PAT
  value: '$(System.AccessToken)'

resources:
  repositories:
  - repository: MicroBuildTemplate
    type: git
    name: 1ESPipelineTemplates/MicroBuildTemplate
    ref: refs/tags/release

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    pool:
      name: VSEngSS-MicroBuild2017-1ES
    stages:
    - stage: stage
      jobs:
      - job: job
        templateContext:
          mb:
            signing:
              enabled: true
              signType: $(SignType)
          outputs:
          - output: pipelineArtifact
            displayName: 'Publish Artifact: logs'
            targetPath: 'artifacts\$(BuildConfiguration)\log'
            artifactName: logs
            condition: succeededOrFailed()
          - output: pipelineArtifact
            displayName: 'Publish Artifact: packages'
            targetPath: 'artifacts\$(BuildConfiguration)\packages'
            artifactName: packages
            condition: succeededOrFailed()
          - output: pipelineArtifact
            displayName: 'Publish Artifact: vsix'
            targetPath: 'artifacts\$(BuildConfiguration)\VSSetup\Insertion'
            artifactName: vsix
            condition: succeededOrFailed()
          - output: pipelineArtifact
            displayName: 'Publish Artifact: symbols'
            targetPath: '$(Build.ArtifactStagingDirectory)/symbols'
            artifactName: symbols
            condition: succeededOrFailed()
          - output: microBuildVstsDrop
            displayName: 'Upload VSTS Drop'
            dropFolder: 'artifacts\$(BuildConfiguration)\VSSetup\Insertion'
            dropRetentionDays: 90
            accessToken: '$(System.AccessToken)'
            dropServiceUri: 'https://devdiv.artifacts.visualstudio.com'
            vsDropServiceUri: 'https://vsdrop.corp.microsoft.com/file/v1'
        steps:        
        - task: MicroBuildIBCMergePlugin@1
          displayName: Install IBCMerge Plugin

        - task: CmdLine@1
          displayName: save build number
          inputs:
            filename: echo
            arguments: '##vso[task.setvariable variable=BUILD_BUILDNUMBER_SAVED]%BUILD_BUILDNUMBER%'
          condition: always()

        - task: CmdLine@1
          displayName: Print Vars
          inputs:
            filename: set
          condition: always()

        - task: MSBuild@1
          displayName: 'Get version from Nerdbank.GitVersioning'
          inputs:
            solution: '$(Build.Repository.LocalPath)\build\SetMicrobuildVersion\SetMicrobuildVersion.csproj'
            msbuildArguments: '/t:OutputVersionInfo /restore'
            platform: 'AnyCPU'
            configuration: 'Release'

        - task: MicroBuildSwixPlugin@4
          displayName: Install Swix Plugin
          inputs:
            dropName: 'Products/$(System.TeamProject)/$(Build.Repository.Name)/$(Build.SourceBranchName)/$(Build.BuildNumber)/$(Build.BuildId)'

        - task: CmdLine@1
          displayName: restore build number
          inputs:
            filename: echo
            arguments: '##vso[build.updatebuildnumber]%BUILD_BUILDNUMBER_SAVED%'
          condition: always()

        - task: CmdLine@1
          displayName: Print Vars
          inputs:
            filename: set
          condition: always()
        
        - task: CmdLine@1
          displayName: Run build.cmd
          inputs:
            filename: '$(comspec)'
            arguments: '/c "call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\Common7\Tools\VsDevCmd.bat" & $(Build.Repository.LocalPath)\build.cmd -pack -sign -configuration Release -properties /p:SignType=$(SignType)"'

        - task: CmdLine@1
          displayName: Print bin contents
          inputs:
            filename: dir
            arguments: '/s /b artifacts\>artifacts\$(BuildConfiguration)\log\BinFileListing.log'
          condition: always()

        - task: CopyFiles@2
          displayName: Collect Symbols
          inputs:
            Contents: 'artifacts\$(BuildConfiguration)\bin\**\*.pdb'
            TargetFolder: '$(Build.ArtifactStagingDirectory)/symbols'
            CleanTargetFolder: true

        - task: MicroBuildSwixPlugin@4
          displayName: Reinstall Swix Plugin (to pick up new build number)
          inputs:
            dropName: 'Products/$(System.TeamProject)/$(Build.Repository.Name)/$(Build.SourceBranchName)/$(Build.BuildNumber)/$(Build.BuildId)'
          enabled: false

        - task: PublishSymbols@1
          displayName: Index Sources
          inputs:
            SearchPattern: '**/*.pdb'
            SymbolsFolder: '$(Build.ArtifactStagingDirectory)\symbols'

        - task: ms-vscs-artifact.build-tasks.artifactSymbolTask-1.artifactSymbolTask@0
          displayName: Publish Symbols to Artifact Services
          inputs:
            symbolServiceURI: 'https://microsoft.artifacts.visualstudio.com/DefaultCollection'
            sourcePath: '$(Build.ArtifactStagingDirectory)\symbols'
            usePat: false

        - task: PowerShell@1
          displayName: Microbuild health checks
          inputs:
            scriptName: 'build/MicrobuildTest.ps1'
          enabled: false
          continueOnError: true

        - task: MicroBuildCleanup@1
          displayName: Execute cleanup tasks